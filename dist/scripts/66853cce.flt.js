"undefined"==typeof console&&(this.console={log:function(){},error:function(){}}),window.flt=window.flt||{},window.flt=_.extend(window.flt,{init:function(){flt.app=new flt.Application,Backbone.history.start({pushState:!0})}}),window.flt.Templates=window.flt.Templates||{},window.flt.Templates=_.extend(window.flt.Templates,{templates:{},compiled:{},add:function(a,b){this.templates[a]=b},get:function(a){if(this.compiled[a])return this.templates[a];if(this.templates[a])return this.templates[a]=Handlebars.compile(this.templates[a]),this.compiled[a]=!0,this.templates[a];var b=$("#"+a);return b.length?(this.templates[a]=Handlebars.compile(b.html()),this.compiled[a]=!0,this.templates[a]):(console.error("Can't find template \""+a+'"'),function(){return""})}}),$(document).ready(function(){_.extend(flt,Backbone.Events),flt.init()}),flt.Application=Backbone.Model.extend({url:"/data/data.json",defaults:{},initialize:function(){this.campaign_collection=new flt.CampaignCollection,this.campaign_collection.on("load:success",this.init,this),this.campaign_collection.fetch()},init:function(){this.chart=new flt.Chart({metric_names:["offers","shares","landings","leads","purchases","friends"],width:350,height:300,gap:20}),this.selector=new flt.Selector({max_selected:8,campaign_collection:this.campaign_collection}),this.selector.on("select",this.chartUpdate,this)},chartUpdate:function(a){this.chart.setData(a)}}),flt.Router=Backbone.Router.extend({_previous_route:"",previous_route:"",previous_page_route:"",current_route:"",_back_path:"",back_path:"",route_passed:0,context:{},routes:{"":"landing","/":"landing",".":"landing","l/:lang":"langredirect","l/:lang/":"langredirect",business:"business","business/":"business",how:"how",where:"where",logout:"logout",items:"itemlist",profile:"profile","profile/:slide":"profile","profile/:slide/":"profile","item/:id":"itemedit","item/:id/:slide":"itemedit","item/:id/:slide/":"itemedit",payments:"paysystem","payments/":"paysystem","payments/add/:system":"paysystemadd","payments/add/:system/":"paysystemadd","i/:slide/":"info",404:"er404",403:"er403","*default":"er404"},popoup_routes:["auth","paysystemadd"],logout:function(){localStorage.clear(),this.navigate("/"),window.location.reload()},er404:function(){return console.log("no such route ",arguments),this.trigger("404",arguments),!1},er403:function(){return console.log("access dinied route ",arguments),this.trigger("403",arguments),!1},initialize:function(){var a=_.uniq(_.values(this.routes));_(a).each(function(a){this.on("route:"+a,function(){this.route_passed++,this._previous_route&&this._previous_route!=a&&(this.trigger("reset",this._previous_route,a,this._back_path),this.trigger("reset:"+this._previous_route)),this._previous_route=a,this._back_path=Backbone.history.fragment},this)},this),this.on("reset",function(a,b,c){this.back_path=c,this.current_route=b,this.previous_route=a,this.isPopup(this.previous_route)||(this.previous_page_route=this.previous_route)})},previousWasPopup:function(){return this.isPopup(this.previous_route)},currentIsPopup:function(){return this.isPopup(this.current_route)},isPopup:function(a){return-1!==_.indexOf(this.popoup_routes,a)}}),flt.Campaign=Backbone.Model.extend({defaults:{id:1,title:"Little Inc",metrics:{offers:665,shares:20,landings:1124,leads:1102,purchases:88,friends:74}}}),flt.CampaignCollection=Backbone.Collection.extend({url:"/data/data.json",model:flt.Campaign,fetch:function(a){return a=a||{},a.type="get",a.update=!0,a.remove=!1,a.data={},a.success=_.bind(this.success,this),a.error=_.bind(this.error,this),this.trigger("load:start"),Backbone.Collection.prototype.fetch.call(this,a)},success:function(a,b){b=_.toJSON(b),this.trigger(b.error?"load:error":"load:success")},error:function(){this.trigger("load:error")}}),flt.Selector=Backbone.Model.extend({defaults:{campaign_collection:{},campaigns:[],selected:[],max_selected:8},initialize:function(){this.view=new flt.SelectorView({model:this});var a=this.get("campaign_collection").toJSON().sort(function(a,b){return a.title<b.title?-1:a.title>b.title?1:0});a=_.map(a,function(a){return a.metrics=_.toJSONString(a.metrics),a}),this.set({campaigns:a}),this.view.render(),this.on("change:selected",function(a,b){this.trigger("select",b)},this)},selectCampaign:function(a){var b=this.get("selected");a.id&&b.length<this.get("max_selected")&&(_.where(b,{id:a.id}).length||(b.push(a),this.set("selected",b),this.trigger("change:selected",this,b)))},deselectCampaign:function(a){var b=this;if(a.id)for(var c=this.get("selected"),d=c.length-1;d>=0;d--){var e=c[d];e.id===a.id&&(c.length>1?(c.splice(d,1),b.set("selected",c),b.trigger("change:selected",b,c)):b.set("selected",[]))}},clearSelected:function(){this.set("selected",[])}}),flt.SelectorView=Backbone.View.extend({template:"flt__selector_template",template_selected:"flt__selector-selected_template",el:".selector",events:{"change .selector__dropdown":"selectCampaign","click a.selector__campaign-itm-a":"deselectCampaign"},initialize:function(){this.template=flt.Templates.get(this.template),this.template_selected=flt.Templates.get(this.template_selected),this.model.on("change:selected",this.renderCampaigns,this)},render:function(){var a=this.template(this.model.toJSON());this.$el.html(a),this.$dropdown=this.$el.find(".selector__dropdown"),this.$campaigns=this.$el.find(".selector__campaigns"),this.renderCampaigns(),this.delegateEvents()},renderCampaigns:function(){this.$campaigns.html(this.template_selected({selected:this.model.get("selected")})),this.delegateEvents()},selectCampaign:function(){this.model.selectCampaign(this.$dropdown.find("option:selected").data())},deselectCampaign:function(a){a&&a.preventDefault&&(a.preventDefault(),a.stopPropagation());var b=$(a.currentTarget);return this.model.deselectCampaign(b.data()),!1}}),flt.Chart=Backbone.Model.extend({defaults:{campaigns:[],floors:[],metric_names:["leads"],width:100,height:100,padding_top:20},initialize:function(){this.view=new flt.ChartView({model:this})},setData:function(a){if(_.isArray(a)&&a.length>1){for(var b=[],c=0,d=a.length,e=0,f=this.get("metric_names"),g=f.length,h=0,i=this.get("width"),j=this.get("height"),k=(this.get("padding_top"),[]);g>e;e++){for(h=0,c=0;d>c;c++)h+=a[c].metrics[f[e]];b.push({name:f[e],value:h,point:{x:i,y:j*e/(f.length-1)}})}var l=0,m={},n=[];for(c=0;d>c;c++){for(m=_.extend({},a[c].metrics),n=[],e=0;g>e;e++)l=m[f[e]],n.push({point:{x:0!==b[e].value?i*l/b[e].value:i,y:j*e/(f.length-1)}});k.push({id:a[c].id,title:a[c].title,metrics:n})}for(c=1;d>c;c++)for(m=k[c].metrics,e=0;g>e;e++)m[e].point.x=m[e].point.x+k[c-1].metrics[e].point.x;_(k).reverse(),this.set({campaigns:k,floors:b})}else this.set({campaigns:[],floors:[]});this.view.render()}}),flt.ChartView=Backbone.View.extend({template:"flt__chart_template",el:".chart",initialize:function(){this.template=flt.Templates.get(this.template)},render:function(){var a=this.template(this.model.toJSON());this.$el.html(a)}});